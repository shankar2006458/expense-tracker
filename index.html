<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Expense Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/index.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>Expense Tracker</h1>
                    <p>Track and analyze your spending habits</p>
                </div>
                <button id="add-expense-btn" class="btn btn-gradient">
                    <span class="icon">+</span>
                    Add Expense
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <section class="summary-section">
            <div class="summary-grid">
                <div class="summary-card today-card">
                    <div class="summary-header">
                        <span class="summary-icon">📅</span>
                        <span class="summary-title">Today</span>
                    </div>
                    <div class="summary-amount" id="today-total">$0.00</div>
                </div>
                <div class="summary-card week-card">
                    <div class="summary-header">
                        <span class="summary-icon">📅</span>
                        <span class="summary-title">This Week</span>
                    </div>
                    <div class="summary-amount" id="week-total">$0.00</div>
                </div>
                <div class="summary-card month-card">
                    <div class="summary-header">
                        <span class="summary-icon">📅</span>
                        <span class="summary-title">This Month</span>
                    </div>
                    <div class="summary-amount" id="month-total">$0.00</div>
                </div>
                <div class="summary-card year-card">
                    <div class="summary-header">
                        <span class="summary-icon">📅</span>
                        <span class="summary-title">This Year</span>
                    </div>
                    <div class="summary-amount" id="year-total">$0.00</div>
                </div>
                <div class="summary-card filtered-card">
                    <div class="summary-header">
                        <span class="summary-icon">📊</span>
                        <span class="summary-title">Total Filtered</span>
                    </div>
                    <div class="summary-amount" id="filtered-total">$0.00</div>
                </div>
            </div>
        </section>

        <!-- Highlights -->
        <section class="highlights-section" id="highlights-section" style="display: none;">
            <div class="highlights-grid">
                <div class="highlight-card highest-card" id="highest-card" style="display: none;">
                    <div class="highlight-header">
                        <span class="highlight-icon">📈</span>
                        <span class="highlight-title">Highest Expense</span>
                    </div>
                    <div class="highlight-amount" id="highest-amount">$0.00</div>
                    <div class="highlight-description" id="highest-description"></div>
                </div>
                <div class="highlight-card lowest-card" id="lowest-card" style="display: none;">
                    <div class="highlight-header">
                        <span class="highlight-icon">📉</span>
                        <span class="highlight-title">Lowest Expense</span>
                    </div>
                    <div class="highlight-amount" id="lowest-amount">$0.00</div>
                    <div class="highlight-description" id="lowest-description"></div>
                </div>
            </div>
        </section>

        <!-- Filters -->
        <section class="filters-section">
            <div class="filters-card">
                <div class="filters-content">
                    <div class="filters-row">
                        <div class="search-input-container">
                            <span class="search-icon">🔍</span>
                            <input type="text" id="search-input" placeholder="Search expenses..." class="search-input">
                        </div>
                        
                        <select id="period-select" class="period-select">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>

                        <button id="more-filters-btn" class="btn btn-outline">
                            <span class="icon">🔧</span>
                            More Filters
                        </button>
                    </div>

                    <div id="expanded-filters" class="expanded-filters" style="display: none;">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Category</label>
                                <select id="category-filter" class="filter-select">
                                    <option value="">All categories</option>
                                </select>
                            </div>
                            
                            <div class="filter-group" id="custom-date-group" style="display: none;">
                                <label class="filter-label">Date Range</label>
                                <div class="date-range">
                                    <input type="date" id="date-from" class="date-input">
                                    <input type="date" id="date-to" class="date-input">
                                </div>
                            </div>

                            <div class="filter-actions">
                                <button id="clear-filters-btn" class="btn btn-outline">
                                    <span class="icon">✖</span>
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="main-content">
            <div class="content-grid">
                <!-- Chart Section -->
                <div class="chart-section">
                    <div class="chart-header">
                        <h2>Analytics</h2>
                        <div class="chart-controls">
                            <button id="pie-chart-btn" class="chart-btn active">📊</button>
                            <button id="bar-chart-btn" class="chart-btn">📈</button>
                        </div>
                    </div>
                    <div class="chart-card">
                        <canvas id="expense-chart"></canvas>
                        <div id="no-chart-data" class="no-data" style="display: none;">
                            <div>💸</div>
                            <p>No expenses to display</p>
                        </div>
                    </div>
                    <div id="chart-legend" class="chart-legend"></div>
                </div>

                <!-- Expenses List -->
                <div class="expenses-section">
                    <div class="expenses-header">
                        <h2>Recent Expenses (<span id="expense-count">0</span>)</h2>
                    </div>
                    
                    <div id="expenses-container" class="expenses-container">
                        <div id="no-expenses" class="no-data">
                            <div>💸</div>
                            <p>No expenses found</p>
                            <small>Add your first expense to get started</small>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal for Add/Edit Expense -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Expense</h3>
            </div>
            <form id="expense-form" class="expense-form">
                <div class="form-group">
                    <label for="amount">Amount</label>
                    <input type="number" id="amount" step="0.01" placeholder="0.00" required>
                    <div class="error-message" id="amount-error"></div>
                </div>

                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="">Select a category</option>
                    </select>
                    <div class="error-message" id="category-error"></div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="What did you spend money on?" required></textarea>
                    <div class="error-message" id="description-error"></div>
                </div>

                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" required>
                    <div class="error-message" id="date-error"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="save-btn" class="btn btn-gradient">
                        <span class="icon">💾</span>
                        <span id="save-text">Add Expense</span>
                    </button>
                    <button type="button" id="cancel-btn" class="btn btn-outline">
                        <span class="icon">✖</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <footer style="text-align: center; padding: 10px; font-size: 14px; color: #888;">
        © Developed By ~ Shankar Prasad Pyke.
    </footer>

    <script>
        const firebaseConfig = {
        apiKey: "AIzaSyBaJuRDPybcM-dniVwWWRz8EoZ1gtLPTyo",
        authDomain: "personal-expense-tracker-c3a19.firebaseapp.com",
        projectId: "personal-expense-tracker-c3a19",
        storageBucket: "personal-expense-tracker-c3a19.firebasestorage.app",
        messagingSenderId: "539622818595",
        appId: "1:539622818595:web:b588061ba12bbc3839c296",
        measurementId: "G-NX5M6M9QSP"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Personal Expense Tracker - Vanilla JavaScript

        // Global state and configuration
        let expenses = [];
        let currentChart = null;
        let chartType = 'pie';
        let isEditMode = false;
        let editingExpenseId = null;

        const EXPENSE_CATEGORIES = [
            'Food & Dining',
            'Transportation', 
            'Shopping',
            'Entertainment',
            'Bills & Recharge',
            'Healthcare',
            'Travel',
            'Education',
            'Insurance',
            'Investments',
            'Gifts & Donations',
            'Personal Care',
            'Petrol',
            'Technology',
            'Other'
        ];

        const CATEGORY_ICONS = {
            'Food & Dining': '🍽️',
            'Transportation': '🚗',
            'Shopping': '🛍️',
            'Entertainment': '🎬',
            'Bills & Recharge': '📋',
            'Healthcare': '🏥',
            'Travel': '✈️',
            'Education': '📚',
            'Insurance': '🛡️',
            'Investments': '📈',
            'Gifts & Donations': '🎁',
            'Personal Care': '💅',
            'Petrol': '🏠',
            'Technology': '💻',
            'Other': '📦'
        };

        const CHART_COLORS = [
            'hsl(195, 85%, 41%)',   // Primary
            'hsl(145, 80%, 42%)',   // Success
            'hsl(43, 89%, 60%)',    // Warning
            'hsl(280, 65%, 60%)',   // Purple
            'hsl(25, 95%, 53%)',    // Orange
            'hsl(340, 75%, 55%)',   // Pink
            'hsl(200, 95%, 45%)',   // Light Blue
            'hsl(120, 60%, 50%)',   // Green
        ];

        let filters = {
            search: '',
            category: '',
            dateRange: { from: null, to: null },
            period: 'all'
        };

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function isToday(date) {
            const today = new Date();
            const checkDate = new Date(date);
            return checkDate.toDateString() === today.toDateString();
        }

        function isThisWeek(date) {
            const today = new Date();
            const checkDate = new Date(date);
        
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday
        
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Saturday
        
            return checkDate >= startOfWeek && checkDate <= endOfWeek;
        }

        function isThisMonth(date) {
            const today = new Date();
            const checkDate = new Date(date);
            return checkDate.getMonth() === today.getMonth() && 
                checkDate.getFullYear() === today.getFullYear();
        }

        function isThisYear(date) {
            const today = new Date();
            const checkDate = new Date(date);
            return checkDate.getFullYear() === today.getFullYear();
        }

        function isWithinDateRange(date, from, to) {
            if (!from || !to) return true;
            const checkDate = new Date(date);
            const fromDate = new Date(from);
            const toDate = new Date(to);
            return checkDate >= fromDate && checkDate <= toDate;
        }

        function saveToFirestore(expense) {
            db.collection('expenses').doc(expense.id).set(expense);
        }

        function loadFromFirestore() {
            db.collection('expenses').orderBy('date', 'desc').onSnapshot(snapshot => {
                expenses = [];
                snapshot.forEach(doc => expenses.push(doc.data()));
                updateAllUI();
            });
        }

        // Filter functions
        function filterExpenses() {
            let filtered = [...expenses];

            // Search filter
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                filtered = filtered.filter(expense => 
                    expense.description.toLowerCase().includes(searchTerm) ||
                    expense.category.toLowerCase().includes(searchTerm) ||
                    expense.amount.toString().includes(searchTerm)
                );
            }

            // Category filter
            if (filters.category) {
                filtered = filtered.filter(expense => expense.category === filters.category);
            }

            // Date range filter
            if (filters.dateRange.from && filters.dateRange.to) {
                filtered = filtered.filter(expense => 
                    isWithinDateRange(expense.date, filters.dateRange.from, filters.dateRange.to)
                );
            } else if (filters.period !== 'all' && filters.period !== 'custom') {
                filtered = filtered.filter(expense => {
                    switch (filters.period) {
                        case 'today':
                            return isToday(expense.date);
                        case 'week':
                            return isThisWeek(expense.date);
                        case 'month':
                            return isThisMonth(expense.date);
                        case 'year':
                            return isThisYear(expense.date);
                        default:
                            return true;
                    }
                });
            }

            // Sort by date (newest first)
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function calculateSummaryStats() {
            const todayExpenses = expenses.filter(e => isToday(e.date));
            const weekExpenses = expenses.filter(e => isThisWeek(e.date));
            const monthExpenses = expenses.filter(e => isThisMonth(e.date));
            const yearExpenses = expenses.filter(e => isThisYear(e.date));
            const filteredExpenses = filterExpenses();

            return {
                today: todayExpenses.reduce((sum, e) => sum + e.amount, 0),
                week: weekExpenses.reduce((sum, e) => sum + e.amount, 0),
                month: monthExpenses.reduce((sum, e) => sum + e.amount, 0),
                year: yearExpenses.reduce((sum, e) => sum + e.amount, 0),
                total: filteredExpenses.reduce((sum, e) => sum + e.amount, 0),
                highest: filteredExpenses.length > 0 ? filteredExpenses.reduce((max, e) => e.amount > max.amount ? e : max) : null,
                lowest: filteredExpenses.length > 0 ? filteredExpenses.reduce((min, e) => e.amount < min.amount ? e : min) : null
            };
        }

        function getCategoryBreakdown(expenseList) {
            const categoryMap = new Map();
            
            expenseList.forEach(expense => {
                if (categoryMap.has(expense.category)) {
                    const current = categoryMap.get(expense.category);
                    categoryMap.set(expense.category, {
                        total: current.total + expense.amount,
                        count: current.count + 1
                    });
                } else {
                    categoryMap.set(expense.category, {
                        total: expense.amount,
                        count: 1
                    });
                }
            });

            return Array.from(categoryMap.entries())
                .map(([category, data]) => ({ category, ...data }))
                .sort((a, b) => b.total - a.total);
        }

        // UI Update functions
        function updateSummaryCards() {
            const stats = calculateSummaryStats();
            
            document.getElementById('today-total').textContent = formatCurrency(stats.today);
            document.getElementById('week-total').textContent = formatCurrency(stats.week);
            document.getElementById('month-total').textContent = formatCurrency(stats.month);
            document.getElementById('year-total').textContent = formatCurrency(stats.year);
            document.getElementById('filtered-total').textContent = formatCurrency(stats.total);
        }

        function updateHighlights() {
            const stats = calculateSummaryStats();
            const highlightsSection = document.getElementById('highlights-section');
            const highestCard = document.getElementById('highest-card');
            const lowestCard = document.getElementById('lowest-card');

            if (stats.highest || stats.lowest) {
                highlightsSection.style.display = 'block';
                
                if (stats.highest) {
                    highestCard.style.display = 'block';
                    document.getElementById('highest-amount').textContent = formatCurrency(stats.highest.amount);
                    document.getElementById('highest-description').textContent = stats.highest.description;
                } else {
                    highestCard.style.display = 'none';
                }
                
                if (stats.lowest) {
                    lowestCard.style.display = 'block';
                    document.getElementById('lowest-amount').textContent = formatCurrency(stats.lowest.amount);
                    document.getElementById('lowest-description').textContent = stats.lowest.description;
                } else {
                    lowestCard.style.display = 'none';
                }
            } else {
                highlightsSection.style.display = 'none';
            }
        }

        function updateExpensesList() {
            const container = document.getElementById('expenses-container');
            const countSpan = document.getElementById('expense-count');
            container.innerHTML = '';

            const filtered = filterExpenses();

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div id="no-expenses" class="no-data">
                        <div>💸</div>
                        <p>No expenses found</p>
                        <small>Add your first expense to get started</small>
                    </div>
                `;
            } else {
                filtered.forEach(expense => {
                    container.appendChild(createExpenseCard(expense));
                });
            }

            countSpan.textContent = filtered.length;
        }

        function createExpenseCard(expense) {
            const card = document.createElement('div');
            card.className = 'expense-card';
            
            const categoryIcon = CATEGORY_ICONS[expense.category] || '📦';
            
            card.innerHTML = `
                <div class="expense-content">
                    <div class="expense-info">
                        <div class="expense-icon">${categoryIcon}</div>
                        <div class="expense-details">
                            <h3>${expense.description}</h3>
                            <div class="expense-category">${expense.category}</div>
                            <div class="expense-meta">
                                <div class="expense-amount">
                                    <span>💲</span>
                                    <span class="expense-amount-value">${formatCurrency(expense.amount)}</span>
                                </div>
                                <div class="expense-date">
                                    <span>📅</span>
                                    <span>${formatDate(expense.date)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="expense-actions">
                        <button class="expense-action-btn edit-btn" onclick="editExpense('${expense.id}')">
                            ✏️
                        </button>
                        <button class="expense-action-btn delete-btn" onclick="deleteExpense('${expense.id}')">
                            🗑️
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function updateChart() {
            const filtered = filterExpenses();
            const categoryData = getCategoryBreakdown(filtered);
            const canvas = document.getElementById('expense-chart');
            const noDataDiv = document.getElementById('no-chart-data');
            const legendDiv = document.getElementById('chart-legend');

            if (categoryData.length === 0) {
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                canvas.style.display = 'none';
                noDataDiv.style.display = 'flex';
                legendDiv.innerHTML = '';
                return;
            }

            canvas.style.display = 'block';
            noDataDiv.style.display = 'none';

            // Prepare chart data
            const chartData = {
                labels: categoryData.map(item => item.category),
                datasets: [{
                    data: categoryData.map(item => item.total),
                    backgroundColor: categoryData.map((_, index) => CHART_COLORS[index % CHART_COLORS.length]),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };

            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = canvas.getContext('2d');

            if (chartType === 'pie') {
                currentChart = new Chart(ctx, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = formatCurrency(context.raw);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Update legend for pie chart
                if (chartType === 'pie') {
                    legendDiv.innerHTML = categoryData.slice(0, 6).map((item, index) => `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${CHART_COLORS[index % CHART_COLORS.length]}"></div>
                            <span class="legend-text">${item.category}: ${formatCurrency(item.total)}</span>
                        </div>
                    `).join('');
                } else {
                    legendDiv.innerHTML = '';
                }
            } else {
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Amount: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
                legendDiv.innerHTML = '';
            }
        }

        function updateAllUI() {
            updateSummaryCards();
            updateHighlights();
            updateExpensesList();
            updateChart();
        }

        // Modal functions
        function showModal() {
            const modal = document.getElementById('expense-modal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            const modal = document.getElementById('expense-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            resetForm();
        }

        function resetForm() {
            const form = document.getElementById('expense-form');
            form.reset();
            
            // Reset form state
            isEditMode = false;
            editingExpenseId = null;
            document.getElementById('modal-title').textContent = 'Add New Expense';
            document.getElementById('save-text').textContent = 'Add Expense';
            
            // Clear errors
            const errorMessages = form.querySelectorAll('.error-message');
            errorMessages.forEach(error => error.classList.remove('show'));
            
            const formGroups = form.querySelectorAll('.form-group');
            formGroups.forEach(group => group.classList.remove('error'));
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Set max date to today (prevent future dates)
            document.getElementById('date').max = today;
        }

        // Form validation
        function validateForm() {
            const form = document.getElementById('expense-form');
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value.trim();
            const date = document.getElementById('date').value;
            
            let isValid = true;
            
            // Clear previous errors
            const errorMessages = form.querySelectorAll('.error-message');
            errorMessages.forEach(error => error.classList.remove('show'));
            
            const formGroups = form.querySelectorAll('.form-group');
            formGroups.forEach(group => group.classList.remove('error'));
            
            // Validate amount
            if (!amount || parseFloat(amount) <= 0) {
                showFieldError('amount', 'Amount must be greater than 0');
                isValid = false;
            }
            
            // Validate category
            if (!category) {
                showFieldError('category', 'Category is required');
                isValid = false;
            }
            
            // Validate description
            if (!description) {
                showFieldError('description', 'Description is required');
                isValid = false;
            }
            
            // Validate date (no future dates)
            if (!date) {
                showFieldError('date', 'Date is required');
                isValid = false;
            } else if (new Date(date) > new Date()) {
                showFieldError('date', 'Future dates are not allowed');
                isValid = false;
            }
            
            return isValid;
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const formGroup = field.closest('.form-group');
            const errorElement = formGroup.querySelector('.error-message');
            
            formGroup.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // Toast notifications
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const toastId = generateId();
            toast.innerHTML = `
                <div class="toast-header">${title}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="closeToast('${toastId}')">✕</button>
            `;
            toast.id = toastId;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                closeToast(toastId);
            }, 5000);
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.remove();
            }
        }

        // Expense CRUD operations
        function addExpense(expenseData) {
            const expense = {
                id: generateId(),
                amount: parseFloat(expenseData.amount),
                category: expenseData.category,
                description: expenseData.description,
                date: expenseData.date,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            saveToFirestore(expense);
            showToast('Expense Added', `${formatCurrency(expense.amount)} expense recorded.`);
        }

        function editExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            // Set form to edit mode
            isEditMode = true;
            editingExpenseId = expenseId;
            
            // Update modal title
            document.getElementById('modal-title').textContent = 'Edit Expense';
            document.getElementById('save-text').textContent = 'Update Expense';
            
            // Populate form
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            
            showModal();
        }

        function updateExpense(expenseId, expenseData) {
            db.collection('expenses').doc(expenseId).update({
                amount: parseFloat(expenseData.amount),
                category: expenseData.category,
                description: expenseData.description,
                date: expenseData.date,
                updatedAt: new Date().toISOString()
            }).then(() => {
                showToast('Expense Updated', 'Your expense has been successfully updated.');
            });
        }

        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense?')) {
                db.collection('expenses').doc(expenseId).delete().then(() => {
                    showToast('Expense Deleted', 'Expense has been removed.', 'error');
                });
            }
        }

        // Event listeners
        function initializeEventListeners() {
            // Add expense button
            document.getElementById('add-expense-btn').addEventListener('click', () => {
                resetForm();
                showModal();
            });
            
            // Modal close events
            document.getElementById('cancel-btn').addEventListener('click', hideModal);
            document.getElementById('expense-modal').addEventListener('click', (e) => {
                if (e.target.id === 'expense-modal') {
                    hideModal();
                }
            });
            
            // Form submission
            document.getElementById('expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (!validateForm()) return;
                
                const formData = {
                    amount: document.getElementById('amount').value,
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value.trim(),
                    date: document.getElementById('date').value
                };
                
                if (isEditMode) {
                    updateExpense(editingExpenseId, formData);
                } else {
                    addExpense(formData);
                }
                
                hideModal();
            });
            
            // Search input
            document.getElementById('search-input').addEventListener('input', (e) => {
                filters.search = e.target.value;
                updateAllUI();
            });
            
            // Period filter
            document.getElementById('period-select').addEventListener('change', (e) => {
                const period = e.target.value;
                filters.period = period;
                
                if (period !== 'custom') {
                    filters.dateRange = { from: null, to: null };
                }
                
                // Show/hide custom date range
                const customDateGroup = document.getElementById('custom-date-group');
                if (period === 'custom') {
                    customDateGroup.style.display = 'block';
                } else {
                    customDateGroup.style.display = 'none';
                }
                
                updateAllUI();
            });
            
            // More filters toggle
            document.getElementById('more-filters-btn').addEventListener('click', () => {
                const expandedFilters = document.getElementById('expanded-filters');
                const isExpanded = expandedFilters.style.display === 'block';
                expandedFilters.style.display = isExpanded ? 'none' : 'block';
                
                const btn = document.getElementById('more-filters-btn');
                btn.innerHTML = isExpanded ? 
                    '<span class="icon">🔧</span> More Filters' : 
                    '<span class="icon">🔧</span> Less Filters';
            });
            
            // Category filter
            document.getElementById('category-filter').addEventListener('change', (e) => {
                filters.category = e.target.value;
                updateAllUI();
            });
            
            // Date range filters
            document.getElementById('date-from').addEventListener('change', (e) => {
                filters.dateRange.from = e.target.value;
                updateAllUI();
            });
            
            document.getElementById('date-to').addEventListener('change', (e) => {
                filters.dateRange.to = e.target.value;
                updateAllUI();
            });
            
            // Clear filters
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                filters = {
                    search: '',
                    category: '',
                    dateRange: { from: null, to: null },
                    period: 'all'
                };
                
                // Reset form inputs
                document.getElementById('search-input').value = '';
                document.getElementById('period-select').value = 'all';
                document.getElementById('category-filter').value = '';
                document.getElementById('date-from').value = '';
                document.getElementById('date-to').value = '';
                document.getElementById('custom-date-group').style.display = 'none';
                document.getElementById('expanded-filters').style.display = 'none';
                document.getElementById('more-filters-btn').innerHTML = '<span class="icon">🔧</span> More Filters';
                
                updateAllUI();
            });
            
            // Chart type toggle
            document.getElementById('pie-chart-btn').addEventListener('click', () => {
                chartType = 'pie';
                document.getElementById('pie-chart-btn').classList.add('active');
                document.getElementById('bar-chart-btn').classList.remove('active');
                updateChart();
            });
            
            document.getElementById('bar-chart-btn').addEventListener('click', () => {
                chartType = 'bar';
                document.getElementById('bar-chart-btn').classList.add('active');
                document.getElementById('pie-chart-btn').classList.remove('active');
                updateChart();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // ESC to close modal
                if (e.key === 'Escape') {
                    hideModal();
                }
                
                // Ctrl+N to add new expense
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    resetForm();
                    showModal();
                }
            });
        }

        // Initialization
        function populateCategories() {
            const categorySelect = document.getElementById('category');
            const categoryFilter = document.getElementById('category-filter');
            
            EXPENSE_CATEGORIES.forEach(category => {
                // Form select
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category;
                categorySelect.appendChild(option1);
                
                // Filter select
                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category;
                categoryFilter.appendChild(option2);
            });
        }

        function setDateConstraints() {
            const today = new Date().toISOString().split('T')[0];
            
            // Set max date to today for all date inputs
            document.getElementById('date').max = today;
            document.getElementById('date-from').max = today;
            document.getElementById('date-to').max = today;
            
            // Set default date to today
            document.getElementById('date').value = today;
        }

        function initialize() {
            // Load data from storage
            loadFromFirestore();
            
            // Setup UI
            populateCategories();
            setDateConstraints();
            initializeEventListeners();
            
            // Initial UI update
            updateAllUI();
            
            console.log('Expense Tracker initialized successfully!');
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
